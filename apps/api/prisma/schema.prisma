// Prisma Schema - Amauta
// Base de datos educativa con módulo administrativo escolar
//
// Documentación completa: docs/technical/database.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================================
// MODELOS PRINCIPALES
// ==================================

/// Usuario del sistema (estudiante, educador, admin)
model Usuario {
  id              String    @id @default(cuid())
  email           String    @unique
  nombre          String
  apellido        String
  rol             Rol       @default(ESTUDIANTE)
  password        String // Hash bcrypt
  avatar          String?
  activo          Boolean   @default(true)
  emailVerificado DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  perfil        Perfil?
  cursosCreados Curso[]        @relation("Educador")
  inscripciones Inscripcion[]
  progresos     Progreso[]
  asistencias   Asistencia[]
  calificaciones Calificacion[]
  comunicados    Comunicado[]
  gruposCreados  Grupo[]
  gruposEstudiante GrupoEstudiante[]

  @@index([email])
  @@index([rol])
  @@map("usuarios")
}

/// Rol del usuario en el sistema
enum Rol {
  ESTUDIANTE
  EDUCADOR
  ADMIN_ESCUELA
  SUPER_ADMIN
}

/// Perfil extendido del usuario
model Perfil {
  id        String  @id @default(cuid())
  usuarioId String  @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  bio         String?
  telefono    String?
  pais        String?
  ciudad      String?
  institucion String?

  // Para estudiantes
  matricula String?
  grado     String?

  // Para educadores
  especialidad String[]
  experiencia  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("perfiles")
}

/// Categoría de cursos
model Categoria {
  id          String  @id @default(cuid())
  nombre      String  @unique
  slug        String  @unique
  descripcion String?
  icono       String?

  cursos Curso[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@map("categorias")
}

/// Curso educativo
model Curso {
  id          String      @id @default(cuid())
  titulo      String
  descripcion String
  slug        String      @unique

  educadorId String
  educador   Usuario @relation("Educador", fields: [educadorId], references: [id])

  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id])

  nivel  Nivel
  estado EstadoCurso @default(BORRADOR)

  imagen   String?
  duracion Int? // minutos estimados
  idioma   String  @default("es")

  publicadoEn DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  lecciones     Leccion[]
  inscripciones Inscripcion[]

  @@index([educadorId])
  @@index([categoriaId])
  @@index([estado])
  @@index([slug])
  @@map("cursos")
}

/// Nivel de dificultad del curso
enum Nivel {
  PRINCIPIANTE
  INTERMEDIO
  AVANZADO
}

/// Estado del curso
enum EstadoCurso {
  BORRADOR
  REVISION
  PUBLICADO
  ARCHIVADO
}

/// Lección dentro de un curso
model Leccion {
  id          String      @id @default(cuid())
  titulo      String
  descripcion String?
  orden       Int

  cursoId String
  curso   Curso  @relation(fields: [cursoId], references: [id], onDelete: Cascade)

  tipo     TipoLeccion
  duracion Int? // minutos

  contenido Json // Estructura flexible para diferentes tipos
  recursos  Recurso[]

  publicada Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  progresos Progreso[]

  @@index([cursoId])
  @@index([orden])
  @@map("lecciones")
}

/// Tipo de lección
enum TipoLeccion {
  VIDEO
  TEXTO
  QUIZ
  INTERACTIVO
  DESCARGABLE
}

/// Recurso adjunto a una lección
model Recurso {
  id     String @id @default(cuid())
  nombre String
  tipo   String // video/pdf/image/audio
  url    String
  tamano Int? // bytes

  leccionId String
  leccion   Leccion @relation(fields: [leccionId], references: [id], onDelete: Cascade)

  disponibleOffline Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leccionId])
  @@map("recursos")
}

/// Inscripción de un usuario a un curso
model Inscripcion {
  id String @id @default(cuid())

  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  cursoId String
  curso   Curso  @relation(fields: [cursoId], references: [id])

  estado   EstadoInscripcion @default(ACTIVO)
  progreso Int               @default(0) // 0-100

  inscritoEn   DateTime  @default(now())
  completadoEn DateTime?

  @@unique([usuarioId, cursoId])
  @@index([usuarioId])
  @@index([cursoId])
  @@map("inscripciones")
}

/// Estado de la inscripción
enum EstadoInscripcion {
  ACTIVO
  COMPLETADO
  ABANDONADO
}

/// Progreso de un usuario en una lección
model Progreso {
  id String @id @default(cuid())

  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  leccionId String
  leccion   Leccion @relation(fields: [leccionId], references: [id])

  completado Boolean @default(false)
  porcentaje Int     @default(0) // 0-100

  ultimoAcceso DateTime @default(now())
  completadoEn DateTime?

  // Para quizzes y evaluaciones
  intentos     Int   @default(0)
  mejorPuntaje Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([usuarioId, leccionId])
  @@index([usuarioId])
  @@index([leccionId])
  @@map("progresos")
}

// ==================================
// MÓDULO ADMINISTRATIVO ESCOLAR
// ==================================

/// Institución educativa
model Institucion {
  id   String          @id @default(cuid())
  nombre String
  tipo TipoInstitucion

  direccion String?
  telefono  String?
  email     String?

  activa Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  grupos      Grupo[]
  comunicados Comunicado[]

  @@map("instituciones")
}

/// Tipo de institución educativa
enum TipoInstitucion {
  ESCUELA
  COLEGIO
  UNIVERSIDAD
  CENTRO_FORMACION
}

/// Grupo o clase dentro de una institución
model Grupo {
  id      String  @id @default(cuid())
  nombre  String
  grado   String?
  seccion String?

  institucionId String
  institucion   Institucion @relation(fields: [institucionId], references: [id])

  educadorId String
  educador   Usuario @relation(fields: [educadorId], references: [id])

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  estudiantes    GrupoEstudiante[]
  asistencias    Asistencia[]
  calificaciones Calificacion[]

  @@index([institucionId])
  @@index([educadorId])
  @@map("grupos")
}

/// Relación muchos a muchos entre grupos y estudiantes
model GrupoEstudiante {
  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id])

  estudianteId String
  estudiante   Usuario @relation(fields: [estudianteId], references: [id])

  inscritoEn DateTime @default(now())

  @@id([grupoId, estudianteId])
  @@map("grupos_estudiantes")
}

/// Registro de asistencia
model Asistencia {
  id String @id @default(cuid())

  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id])

  estudianteId String
  estudiante   Usuario @relation(fields: [estudianteId], references: [id])

  fecha  DateTime
  estado EstadoAsistencia

  observaciones String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([grupoId, estudianteId, fecha])
  @@index([grupoId, fecha])
  @@index([estudianteId])
  @@map("asistencias")
}

/// Estado de asistencia
enum EstadoAsistencia {
  PRESENTE
  AUSENTE
  TARDANZA
  JUSTIFICADO
}

/// Calificación de un estudiante
model Calificacion {
  id String @id @default(cuid())

  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id])

  estudianteId String
  estudiante   Usuario @relation(fields: [estudianteId], references: [id])

  materia String
  periodo String // "1er trimestre", "Parcial 1", etc

  nota       Float
  notaMaxima Float @default(10)

  observaciones String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grupoId])
  @@index([estudianteId])
  @@map("calificaciones")
}

/// Comunicado institucional
model Comunicado {
  id String @id @default(cuid())

  institucionId String
  institucion   Institucion @relation(fields: [institucionId], references: [id])

  autorId String
  autor   Usuario @relation(fields: [autorId], references: [id])

  titulo    String
  contenido String

  tipo      TipoComunicado
  prioridad Prioridad      @default(NORMAL)

  publicadoEn DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([institucionId])
  @@index([tipo])
  @@map("comunicados")
}

/// Tipo de comunicado
enum TipoComunicado {
  GENERAL
  ACADEMICO
  ADMINISTRATIVO
  EVENTO
  URGENTE
}

/// Prioridad del comunicado
enum Prioridad {
  BAJA
  NORMAL
  ALTA
  URGENTE
}
